const t={userInfo:"https://pc-api.xuexi.cn/open/api/user/info",totalScore:"https://pc-proxy-api.xuexi.cn/delegate/score/get",todayScore:"https://pc-proxy-api.xuexi.cn/delegate/score/today/query",taskList:"https://pc-proxy-api.xuexi.cn/delegate/score/days/listScoreProgress?sence=score&deviceType=2",todayNews:["https://www.xuexi.cn/lgdata/35il6fpn0ohq.json","https://www.xuexi.cn/lgdata/1ap1igfgdn2.json","https://www.xuexi.cn/lgdata/vdppiu92n1.json","https://www.xuexi.cn/lgdata/152mdtl3qn1.json"],todayVideos:["https://www.xuexi.cn/lgdata/525pi8vcj24p.json","https://www.xuexi.cn/lgdata/11vku6vt6rgom.json","https://www.xuexi.cn/lgdata/2qfjjjrprmdh.json","https://www.xuexi.cn/lgdata/3o3ufqgl8rsn.json","https://www.xuexi.cn/lgdata/591ht3bc22pi.json","https://www.xuexi.cn/lgdata/1742g60067k.json","https://www.xuexi.cn/lgdata/1novbsbi47k.json"],paperList:"https://pc-proxy-api.xuexi.cn/api/exam/service/paper/pc/list",answerSave:"https://a6.qikekeji.com/txt/data/save",answerSearch:"https://a6.qikekeji.com/txt/data/detail",push:"https://www.pushplus.plus/send",generateQRCode:"https://login.xuexi.cn/user/qrcode/generate",loginWithQRCode:"https://login.xuexi.cn/login/login_with_qr",sign:"https://pc-api.xuexi.cn/open/api/sns/sign",secureCheck:"https://pc-api.xuexi.cn/login/secure_check",qrcode:"https://api.qrserver.com/v1/create-qr-code"};var e,n,a,o;function c(t,e){const n=function(t){const e=document.cookie.split(";");for(const n in e){const a=e[n].split("=");if(a[0].trim()===t)return a[1].trim()}return null}(t);null!==n&&function(t,e,n,a){const o=new Date;o.setTime(o.getTime()+n),document.cookie=`${t}=${e};expires=${o.toUTCString()};path=/;domain=${a}`}(t,"",-1,e)}function s(t){return t<10?`0${t}`:`${t}`}function i(...t){r("dodgerblue",...t)}function r(t,...e){const n=e.map((t=>!(t instanceof Function)&&t instanceof Object?t instanceof Error?t.stack:JSON.stringify(t):String(t))).join(" ");console.log(`%c[${function(t=Date.now()){const e=new Date(t),n=e.getSeconds(),a=e.getMinutes(),o=e.getHours(),c=e.getDate(),i=e.getMonth()+1;return`${[e.getFullYear(),i,c].map(s).join("-")} ${[o,a,n].map(s).join(":")}`}()}] %c${n}`,"",`color: ${t}`)}async function u(){i("正在生成登录二维码...");const e=await async function(){try{const e=await fetch(t.generateQRCode,{method:"GET",mode:"cors"});if(e.ok){const t=await e.json();if(t.success)return t.result}}catch(t){}}();if(e){i("生成登录二维码成功!");const n=`https://login.xuexi.cn/login/qrcommit?showmenu=false&code=${e}&appId=dingoankubyrfkttorhpou`;return{code:e,src:`${t.qrcode}?data=${encodeURIComponent(n)}`,url:n}}i("生成登录二维码失败!")}async function d(e,n){i("尝试用二维码登录..."),n.count--;const a=await async function(e){try{const n=new URLSearchParams({qrCode:e,goto:"https://oa.xuexi.cn",pdmToken:""}),a=await fetch(t.loginWithQRCode,{method:"POST",mode:"cors",credentials:"include",headers:{"Content-Type":"application/x-www-form-urlencoded;charset=UTF-8"},body:n.toString()});if(a.ok)return await a.json()}catch(t){}}(e);if(a){const{data:t,code:e,success:n}=a;if(n&&t)return{data:t,status:"success"};if("11019"===e)return{status:"revoked"}}return new Promise((t=>{clearTimeout(n.timer),n.count?n.timer=setTimeout((()=>{t(d(e,n))}),1e3):t({status:"timeout"})}))}async function p(e){i("正在获取签名...");const n=await async function(){try{const e=await fetch(t.sign,{method:"GET",mode:"cors",credentials:"include"});if(e.ok){const t=await e.json();if(t.ok)return t.data.sign}}catch(t){}}();if(n){const a=crypto.randomUUID(),[,o]=e.split("="),c=`${n}${a}`;return await async function(e){try{const n=new URLSearchParams(e),a=`${t.secureCheck}?${n}`,o=await fetch(a,{method:"GET",mode:"cors",credentials:"include"});if(o.ok)return(await o.json()).success}catch(t){}return!1}({code:o,state:c})}return!1}async function l(t,e){const{data:n,type:a}=e;return"tab"===a?await chrome.tabs.sendMessage(e.id,{data:n,action:t}):"runtime"===a?await chrome.runtime.sendMessage({data:n,action:t}):void 0}function h(t,e,n){const{once:a}=n||{},o=(n,o,s)=>{const{action:i,data:r}=n;if(i&&t===i)return e(r,o,s),void(a&&c())},c=()=>{chrome.runtime.onMessage.removeListener(o)};return chrome.runtime.onMessage.addListener(o),c}async function g(e){i(`剩余 ${e} 个新闻`);const n=[],a=await async function(){const e=~~(Math.random()*t.todayNews.length);try{const n=await fetch(t.todayNews[e],{method:"GET"});if(n.ok)return await n.json()}catch(t){}}();if(a&&a.length){const t=a.slice(0,100),o=(new Date).getFullYear().toString();for(;n.length<e;){const e=t[~~(Math.random()*t.length)];e.publishTime.startsWith(o)&&"tuwen"===e.type&&n.push(e)}}return n}async function w(e){i(`剩余 ${e} 个视频`);const n=[],a=await async function(){const e=~~(Math.random()*t.todayVideos.length);try{const n=await fetch(t.todayVideos[e],{method:"GET"});if(n.ok)return await n.json()}catch(t){}}();if(a&&a.length){const t=a.slice(0,100),o=(new Date).getFullYear().toString();for(;n.length<e;){const e=t[~~(Math.random()*t.length)];!e.publishTime.startsWith(o)||"shipin"!==e.type&&"juji"!==e.type||n.push(e)}}return n}!function(t){t[t.AUTO_START=0]="AUTO_START",t[t.SCHEDULE_RUN=1]="SCHEDULE_RUN",t[t.VIDEO_MUTED=2]="VIDEO_MUTED",t[t.RANDOM_EXAM=3]="RANDOM_EXAM",t[t.AUTO_ANSWER=4]="AUTO_ANSWER",t[t.REMOTE_PUSH=5]="REMOTE_PUSH"}(e||(e={})),function(t){t[t.LOGIN=0]="LOGIN",t[t.READ=1]="READ",t[t.WATCH=2]="WATCH",t[t.PRACTICE=3]="PRACTICE"}(n||(n={})),function(t){t[t.LOADING=0]="LOADING",t[t.START=1]="START",t[t.PROGRESS=2]="PROGRESS",t[t.PAUSE=3]="PAUSE",t[t.FINISH=4]="FINISH"}(a||(a={})),function(t){t[t.READ=0]="READ",t[t.WATCH=1]="WATCH"}(o||(o={}));const f="1.0.0.alpha2",y="tech-study-plugin";function m(){const e=setInterval((async()=>{i("尝试连接扩展...");try{await l("connect",{data:null,type:"runtime"})}catch(t){!function(...t){r("red",...t)}("无法连接扩展!")}}),2e3);h("connecting",(async()=>{i("获取连接成功!"),clearInterval(e),await l("connected",{data:null,type:"runtime"}),window.addEventListener("beforeunload",(()=>{l("disconnect",{data:null,type:"runtime"})})),h("getUserInfo",(async()=>{i("获取用户信息..."),l("getUserInfo",{data:await async function(){try{const e=await fetch(t.userInfo,{method:"GET",credentials:"include"});if(e.ok){const{data:t}=await e.json();return t}}catch(t){}}(),type:"runtime"})})),h("getTodayScore",(async()=>{i("获取当天分数..."),l("getTodayScore",{data:await async function(){try{const e=await fetch(t.todayScore,{method:"GET",credentials:"include"});if(e.ok){const{data:t}=await e.json(),{score:n}=t;return n}}catch(t){}}(),type:"runtime"})})),h("getTotalScore",(async()=>{i("获取总分..."),l("getTotalScore",{data:await async function(){try{const e=await fetch(t.totalScore,{method:"GET",credentials:"include"});if(e.ok){const{data:t}=await e.json(),{score:n}=t;return n}}catch(t){}}(),type:"runtime"})})),h("getTaskProgress",(async()=>{i("获取任务进度...");const e=await async function(){try{const e=await fetch(t.taskList,{method:"GET",credentials:"include"});if(e.ok){const{data:t}=await e.json(),{taskProgress:n,inBlackList:a}=t;return{taskProgress:n,inBlackList:a}}}catch(t){}}();if(e){const{taskProgress:t,inBlackList:a}=e,o=[];o[n.LOGIN]={currentScore:t[2].currentScore,dayMaxScore:t[2].dayMaxScore,need:0,status:!1},o[n.READ]={currentScore:t[0].currentScore,dayMaxScore:t[0].dayMaxScore,need:0,status:!1},o[n.WATCH]={currentScore:t[1].currentScore,dayMaxScore:t[1].dayMaxScore,need:0,status:!1},o[n.PRACTICE]={currentScore:t[3].currentScore,dayMaxScore:t[3].dayMaxScore,need:0,status:!1};for(const t in o){const{currentScore:e,dayMaxScore:n}=o[t],a=Number((100*e/n).toFixed(1));o[t].status=100===a,o[t].need=n-e}l("getTaskProgress",{data:{taskProgress:o,inBlackList:a},type:"runtime"})}l("getTaskProgress",{data:void 0,type:"runtime"})})),h("getNews",(async t=>{l("getNews",{data:await g(t),type:"runtime"})})),h("getVideos",(async t=>{l("getVideos",{data:await w(t),type:"runtime"})})),function(){const t={timer:-1,count:10};h("login",(async()=>{clearTimeout(t.timer),i("刷新登录二维码!");const e=await u();if(e){const{src:n,code:a,url:o}=e;l("qrcode",{data:{src:n,url:o,revoked:!1},type:"runtime"});const c=await d(a,t);if("success"===c.status){const{data:t}=c;if(await p(t))return i("登录成功!"),void l("login",{data:!0,type:"runtime"})}return"revoked"===c.status?(function(...t){r("yellow",...t)}("登录二维码失效!"),void l("qrcode",{data:{src:n,url:o,revoked:!0},type:"runtime"})):"timeout"===c.status?(i("登录超时!"),void l("login",{data:!1,type:"runtime"})):(i("登录失败!"),void l("login",{data:!1,type:"runtime"}))}})),h("logout",(async()=>{c("token",".xuexi.cn"),i("退出登录!")}))}()})),h("occupied",(()=>{i("连接被占用!"),clearInterval(e)}))}i("主页 脚本注入成功"),console.log(`%c ${y} %c v${f} `,"background:dodgerblue;color:white;font-size:15px;border-radius:4px 0 0 4px;padding:2px 0;","background:black;color:gold;font-size:15px;border-radius:0 4px 4px 0;padding:2px 0;"),window.addEventListener("load",(()=>{i("初始化"),m()}));
